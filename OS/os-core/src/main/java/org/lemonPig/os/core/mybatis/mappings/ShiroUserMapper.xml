<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.lemonPig.os.core.mapper.ShiroUserMapper">
	<resultMap id="userMap" type="org.lemonPig.os.core.vo.User">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Sun Jul 05 
			20:26:04 GMT+08:00 2015. -->
		<id column="USER_ID" jdbcType="BIGINT" property="id" />
		<result column="USER_USERNAME" jdbcType="VARCHAR" property="username" />
		<result column="USER_PASSWORD" jdbcType="VARCHAR" property="password" />
		<result column="USER_STATUS" jdbcType="INTEGER" property="status" />
		<result column="USER_SALT" jdbcType="VARCHAR" property="salt" />
		<result column="USER_TEL" jdbcType="VARCHAR" property="tel" />
		<result column="USER_MAIL" jdbcType="VARCHAR" property="mail" />
		<collection property="roles" ofType="org.lemonPig.os.core.vo.Role" resultMap="roleResultMap" />
		<collection property="permissions" ofType="org.lemonPig.os.core.vo.Permission" resultMap="userPermissionResultMap"/>
	</resultMap>
	<resultMap id="roleResultMap" type="org.lemonPig.os.core.vo.Role">
		<id column="ROLE_ID" property="id" jdbcType="BIGINT" />
		<result column="ROLE_ENAME" property="ename" jdbcType="VARCHAR" />
		<result column="ROLE_CNAME" property="cname" jdbcType="VARCHAR" />
		<result column="ROLE_GRANTABLE" property="grantable" jdbcType="TINYINT" />
		<collection property="permissions" ofType="org.lemonPig.os.core.vo.Permission"
			resultMap="rolePermissionResultMap" />
	</resultMap>
	<resultMap id="rolePermissionResultMap" type="org.lemonPig.os.core.vo.Permission">
		<id column="ROLE_PERMISSION_ID" property="id" jdbcType="BIGINT" />
		<result column="ROLE_PERMISSION_CNAME" property="cname" jdbcType="VARCHAR" />
		<result column="ROLE_PERMISSION_ENAME" property="ename" jdbcType="VARCHAR" />
	</resultMap>
	<resultMap id="userPermissionResultMap" type="org.lemonPig.os.core.vo.Permission">
		<id column="USER_PERMISSION_ID" property="id" jdbcType="BIGINT" />
		<result column="USER_PERMISSION_CNAME" property="cname" jdbcType="VARCHAR" />
		<result column="USER_PERMISSION_ENAME" property="ename" jdbcType="VARCHAR" />
		<result column="USER_PERMISSION_GRANTABLE" property="grantable" jdbcType="TINYINT" />
	</resultMap>

	<select id="selectLoginUserByUsername" parameterType="java.lang.String" resultMap="userMap">
		SELECT
			ur.*,
			up.ID AS USER_PERMISSION_ID,
			up.ENAME AS USER_PERMISSION_ENAME,
			up.CNAME AS USER_PERMISSION_CNAME,
			up.GRANTABLE AS USER_PERMISSION_GRANTABLE,
			up.GRANT_USER_ID AS USER_GRANT_USER_ID,
			rp.ID AS ROLE_PERMISSION_ID,
			rp.ENAME AS ROLE_PERMISSION_ENAME,
			rp.CNAME AS ROLE_PERMISSION_CNAME
		FROM
		(
			SELECT
				u.ID AS USER_ID,
				u.USERNAME AS USER_USERNAME,
				u.`PASSWORD` AS USER_PASSWORD,
				u.SALT AS USER_SALT,
				u.`STATUS` AS USER_STATUS,
				u.TEL AS USER_TEL,
				r.ID AS ROLE_ID,
				r.ENAME AS ROLE_ENAME,
				r.CNAME AS ROLE_CNAME,
				ur.GRANTABLE AS ROLE_GRANTABLE,
				ur.GRANTED_USER_ID AS ROLE_GRANTED_USER_ID
			FROM
				USER_ROLE ur
			RIGHT JOIN USER u ON ur.USER_ID = u.ID
			LEFT JOIN ROLE r ON ur.ROLE_ID = r.ID
		WHERE u.USERNAME=#{username}
		)ur
		LEFT JOIN(
			SELECT
				up.*,
				p.*
			FROM
				USER_PERMISSION up
				LEFT JOIN PERMISSION p ON up.PERMISSION_ID = p.ID
			)up ON ur.USER_ID = up.USER_ID
		LEFT JOIN(
			SELECT
				rp.*,
				p.*
			FROM
				ROLE_PERMISSION rp
			LEFT JOIN PERMISSION p ON rp.PERMISSION_ID = p.ID
		)rp ON rp.ROLE_ID = ur.ROLE_ID
	</select>
</mapper>